<!doctype html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <!-- AR.js for A-Frame (includes new-location-based components) -->
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
    <style>
      /* Full-screen, correct aspect on all devices */
      html, body {
        margin: 0;
        padding: 0;
        width: 100dvw;
        height: 100dvh;
        overflow: hidden;
      }
      a-scene {
        position: fixed !important;
        inset: 0 !important;
        width: 100dvw !important;
        height: 100dvh !important;
        z-index: 1 !important;
      }
      /* Let AR.js video fill safely without distortion (use 'cover' to crop) */
      video[playsinline] {
        position: fixed;
        inset: 0;
        width: 100dvw;
        height: 100dvh;
        object-fit: contain; /* change to 'cover' if you prefer edge-to-edge with crop */
        z-index: -1;
      }

      /* UI */
      .ui-panel{position:fixed;top:10px;left:10px;z-index:100;background:rgba(0,0,0,.7);padding:8px;border-radius:8px;color:#fff;font-family:Arial,sans-serif;max-width:90vw}
      .ui-button{background:#4CAF50;border:none;color:#fff;padding:6px 10px;margin:3px;border-radius:4px;cursor:pointer;font-size:11px;white-space:nowrap}
      .ui-button:hover{background:#45a049}
      .ui-button.active{background:#2196F3}
      .ui-button.delete{background:#f44336}
      .ui-button.delete:hover{background:#da190b}
      .object-counter{margin-top:6px;font-size:10px}
      .instructions{position:fixed;bottom:10px;left:10px;z-index:100;background:rgba(0,0,0,.7);padding:6px 10px;border-radius:5px;color:#fff;font-family:Arial,sans-serif;font-size:11px;max-width:90vw}
      .row{margin-top:6px}
      input[type="number"]{width:90px;border-radius:4px;border:none;padding:4px;margin-right:4px;font-size:11px}
      
      /* Responsive */
      @media (max-width: 768px) {
        .ui-panel{padding:6px;top:5px;left:5px}
        .ui-button{padding:5px 8px;margin:2px;font-size:10px}
        .object-counter{font-size:9px}
        .instructions{font-size:10px;bottom:5px;left:5px;padding:5px 8px}
        input[type="number"]{width:70px;padding:3px;font-size:10px}
      }
      @media (max-width: 400px) {
        .ui-panel{padding:4px;top:3px;left:3px}
        .ui-button{padding:4px 6px;margin:2px;font-size:9px}
        .object-counter{font-size:8px}
        .instructions{font-size:9px;bottom:3px;left:3px;padding:4px 6px}
        input[type="number"]{width:60px;padding:2px;font-size:9px}
      }

      /* iOS motion permission button */
      .ios-motion-btn{
        position:fixed;bottom:12px;left:12px;z-index:999;background:#2196F3;border:none;color:#fff;
        padding:8px 12px;border-radius:5px;cursor:pointer;font-size:12px;
      }
      @media (max-width: 768px) {.ios-motion-btn{bottom:8px;left:8px;padding:6px 10px;font-size:11px}}
      @media (max-width: 400px) {.ios-motion-btn{bottom:5px;left:5px;padding:5px 8px;font-size:10px}}
    </style>
  </head>
  <body>
    <!-- UI -->
    <div class="ui-panel">
      <div>
        <button class="ui-button" onclick="placeGLBInFront('duck', true)">Place duck (GLB)</button>

        <button class="ui-button active" id="cube-btn" onclick="selectObjectType('box')">Box</button>
        <button class="ui-button" id="sphere-btn" onclick="selectObjectType('avocado')">Avocado</button>
        <button class="ui-button" id="cylinder-btn" onclick="selectObjectType('piano')">Piano</button>
        <button class="ui-button" id="arrow-btn" onclick="selectObjectType('ghost')">ghost</button>
        <button class="ui-button" id="textBox-btn" onclick="selectObjectType('textBox')">Text Box</button>
      </div>
      <div class="row">
        <button class="ui-button"
        onclick="mode='tap'; setActiveMode(); placeInFront(2)">
        Tap-to-place (2 m)
        </button>
        <button class="ui-button" onclick="mode='gps'; setActiveMode()">GPS pin</button>
      </div>
      <div class="row" id="gps-row" style="display:none">
        <input id="lat" type="number" step="0.000001" placeholder="lat e.g. 49.2827">
        <input id="lon" type="number" step="0.000001" placeholder="lon e.g. -123.1207">
        <button class="ui-button" onclick="addAtInputs()">Add @ lat/lon</button>
      </div>
      <div class="row">
        <button class="ui-button delete" onclick="deleteSelectedObject()">Delete Selected</button>
        <button class="ui-button delete" onclick="clearAllObjects()">Clear All</button>
      </div>
      <div class="object-counter">Pins: <span id="object-count">0</span></div>
    </div>

    <div class="instructions">Camera will request permission. Tap to place (Tap mode) or add GPS pin. GPS pins are saved & restored.</div>
    <!-- A-Frame + AR.js-->
    <a-scene
      embedded
      vr-mode-ui="enabled:false"
      renderer="logarithmicDepthBuffer:true; alpha: true;">


      <!-- Basic camera (no GPS here; GPS anchor is created per-entity) -->
      <a-camera id="cam" position="0 0 0" look-controls="enabled: false" wasd-controls="enabled: false"></a-camera>

      <!-- Optional helper plane for editing (not real plane detection) -->
      <a-plane id="edit-plane" rotation="-90 0 0" width="200" height="200"
               position="0 0 -4" visible="false"></a-plane>

      <!-- Mouse cursor for desktop debugging -->
      <a-entity cursor="rayOrigin: mouse"
                raycaster="objects: a-box, a-sphere, a-cylinder, a-entity[id^='object-']"></a-entity>
    </a-scene>

    <!-- iOS motion permission -->
    <button id="iosPerm" class="ios-motion-btn">Enable Motion</button>

    <script>
      // ---------- UI state ----------
      let mode = 'tap'; // 'tap' or 'gps'
      function setActiveMode(){
        document.getElementById('gps-row').style.display = (mode==='gps')?'block':'none';
      }

      iosPerm.onclick = async () => {
        const DM = window.DeviceMotionEvent;
        if (DM && typeof DM.requestPermission === 'function') {
          try { await DM.requestPermission(); } catch(e) {}
        }
        iosPerm.remove();
      };

      // ---------- Object definitions ----------
      const objectTypes = {
        cube:{primitive:'a-box',color:'orange',width:0.5,height:0.5,depth:0.5},
        sphere:{primitive:'a-sphere',color:'blue',radius:0.3},
        cylinder:{primitive:'a-cylinder',color:'green',radius:0.3,height:0.6},
        arrow:{type:"group",parts:[
          {primitive:"a-cylinder",color:"#F00",height:0.6,radius:0.05,position:"0 0 0"},
          {primitive:"a-cone",color:"#F00",height:0.3,radiusBottom:0.12,position:"0 0.45 0"}]},
        textBox:{type:"group",parts:[
          {primitive:"a-plane",color:"#FFFFFF",width:1.5,height:0.6,position:"0 0 0"},
          {primitive:"a-entity",text:"value: Example Text; color: black; width: 2; align: center",position:"0 0.25 0"},
          {primitive:"a-sphere",radius:0.05,color:"red",position:"0.75 0.3 0.02",class:"resize-handle"},
          {primitive:"a-sphere",radius:0.05,color:"red",position:"-0.75 0.3 0.02",class:"resize-handle"},
          {primitive:"a-sphere",radius:0.05,color:"red",position:"0.75 -0.3 0.02",class:"resize-handle"},
          {primitive:"a-sphere",radius:0.05,color:"red",position:"-0.75 -0.3 0.02",class:"resize-handle"}]}
      };
      let currentObjectType='cube', selectedObject=null, objectCounter=0, isResizing=false;

      window.selectObjectType = (t)=>{
        currentObjectType=t;
        document.querySelectorAll('.ui-button').forEach(b=>b.classList.remove('active'));
        const btn=document.getElementById(t+'-btn'); if(btn) btn.classList.add('active');
      };

      // ---------- Persistence (localStorage) ----------
      const STORAGE_KEY = 'ar_objects_v1'; // records: { id, type, lat, lon }

      const loadRecords = () => {
        try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
        catch { return []; }
      };
      const saveRecords = (recs) => localStorage.setItem(STORAGE_KEY, JSON.stringify(recs));
      const addRecord = (rec) => { const r = loadRecords(); r.push(rec); saveRecords(r); };
      const removeRecordById = (id) => { saveRecords(loadRecords().filter(x => x.id !== id)); };
      const clearAllRecords = () => localStorage.removeItem(STORAGE_KEY);

      // ---------- Build object ----------
      function buildObject(positionVec3){
        const sceneEl = document.querySelector('a-scene');
        const objData = objectTypes[currentObjectType];
        let newObj;

        if (objData.type==="group"){
          newObj = document.createElement("a-entity");
          newObj.setAttribute("position", `${positionVec3.x} ${positionVec3.y} ${positionVec3.z}`);
          objData.parts.forEach(part=>{
            const el=document.createElement(part.primitive);
            for(const [k,v] of Object.entries(part)){
              if(k==="primitive"||k==="position") continue;
              if(k==="text"){
                const m={}; v.split(";").forEach(s=>{
                  if(!s.trim()) return; const [kk,vv]=s.split(":").map(x=>x.trim()); m[kk]=isNaN(vv)?vv:parseFloat(vv);
                });
                el.setAttribute("text", m);
              }else el.setAttribute(k, v);
            }
            if(part.position) el.setAttribute("position", part.position);
            newObj.appendChild(el);
          });
          if(currentObjectType==="textBox") makeTextBoxResizable(newObj);
        }else{
          newObj = document.createElement(objData.primitive);
          newObj.setAttribute("position", `${positionVec3.x} ${positionVec3.y} ${positionVec3.z}`);
          newObj.setAttribute("visible", true);
        }

        newObj.setAttribute("id", `object-${objectCounter++}`);
        newObj.addEventListener("click", selectObject);
        sceneEl.appendChild(newObj);
        return newObj;
      }

      function makeTextBoxResizable(ent){
        const plane = ent.querySelector("a-plane");
        const text  = ent.querySelector("a-entity[text]");
        const handles = Array.from(ent.querySelectorAll(".resize-handle"));
        ent.userData = { plane, text, handles };
      }

      // ---------- Placement ----------
      // Tap mode: ~2m ahead (not persisted; AR.js has no world anchors)
      function placeInFront(distanceM=2){
        console.log("I RANNNN")
        const camEl = document.getElementById('cam');
        const camObj = camEl.object3D;
        const dir = new THREE.Vector3();
        camObj.getWorldDirection(dir);
        const pos = new THREE.Vector3();
        camObj.getWorldPosition(pos);
        const target = pos.add(dir.multiplyScalar(distanceM));
        target.y += 0.2;
        buildObject(target);
        updateObjectCount(); // do not persist
      }

      // GPS mode: persist lat/lon so it can be restored next time
      function addAtLatLng(lat, lon, typeOverride){
        const sceneEl = document.querySelector('a-scene');
        const type = typeOverride || currentObjectType;

        const anchor = document.createElement('a-entity');
        const anchorId = `object-${objectCounter++}`;
        anchor.setAttribute('gps-new-entity-place', `latitude:${lat}; longitude:${lon}`);
        anchor.setAttribute('id', anchorId);

        // build the visual as a child at local (0,0,0)
        const childType = type;
        const tmpType = currentObjectType;
        currentObjectType = childType;
        const child = buildObject(new THREE.Vector3(0,0,0));
        currentObjectType = tmpType;
        anchor.appendChild(child);

        sceneEl.appendChild(anchor);

        // Persist this anchor
        addRecord({ id: anchorId, type, lat, lon });

        updateObjectCount();
        return anchor;
      }

      window.addAtInputs = ()=>{
        const lat=parseFloat(document.getElementById('lat').value);
        const lon=parseFloat(document.getElementById('lon').value);
        if(Number.isFinite(lat)&&Number.isFinite(lon)) addAtLatLng(lat,lon);
      };

      // ---------- Selection / deletion ----------
      function selectObject(e){
        e.stopPropagation();
        // If you clicked a child inside a GPS anchor, select the anchor
        let el = e.currentTarget;
        if (el.parentElement && el.parentElement.hasAttribute('gps-new-entity-place')) {
          el = el.parentElement;
        }
        // remove highlight from previous (only if it was a direct geometry)
        if (selectedObject && !selectedObject.hasAttribute('gps-new-entity-place')) {
          selectedObject.setAttribute('material', 'color:'+getOriginalColor(selectedObject));
        }
        selectedObject = el;

        // highlight geometry child (anchors by themselves may have no material)
        if (!selectedObject.hasAttribute('gps-new-entity-place')) {
          selectedObject.setAttribute('material','color:red');
        } else {
          const geomChild = selectedObject.querySelector('a-box, a-sphere, a-cylinder, a-entity:not([gps-new-entity-place])');
          if (geomChild && geomChild.dataset?.baseColor) {
            geomChild.setAttribute('material','color:red');
          }
        }
      }
      function getOriginalColor(obj){ return obj.dataset?.baseColor || 'gray'; }

      window.deleteSelectedObject = ()=>{
        if(!selectedObject) return;
        const sceneEl = document.querySelector('a-scene');

        if (selectedObject.hasAttribute('gps-new-entity-place')){
          removeRecordById(selectedObject.id);
          sceneEl.removeChild(selectedObject);
        } else {
          const parent = selectedObject.parentElement;
          if (parent && parent.hasAttribute('gps-new-entity-place')) {
            removeRecordById(parent.id);
            sceneEl.removeChild(parent);
          } else {
            sceneEl.removeChild(selectedObject);
          }
        }
        selectedObject=null; updateObjectCount();
      };

      window.clearAllObjects = ()=>{
        const sceneEl = document.querySelector('a-scene');
        clearAllRecords();
        // Remove all GPS anchors and any loose non-anchor objects
        sceneEl.querySelectorAll("[gps-new-entity-place]").forEach(n=>sceneEl.removeChild(n));
        sceneEl.querySelectorAll("a-box, a-sphere, a-cylinder, a-entity[id^='object-']").forEach(n=>{
          if (!n.hasAttribute('gps-new-entity-place') && n.parentElement===sceneEl) sceneEl.removeChild(n);
        });
        selectedObject=null; updateObjectCount();
      };

      function updateObjectCount(){
        const sceneEl = document.querySelector('a-scene');
        const count = sceneEl.querySelectorAll("[gps-new-entity-place]").length;
        document.getElementById('object-count').textContent = count;
      }

      // ---------- Restore persisted GPS pins on load ----------
      window.addEventListener('DOMContentLoaded', ()=>{
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
          console.warn('Camera + geolocation require HTTPS (or localhost) on mobile.');
        }

        const recs = loadRecords();
        // Rebuild each GPS anchor and give it the same id for future deletes
        recs.forEach(rec => {
          const anchor = addAtLatLng(rec.lat, rec.lon, rec.type);
          anchor.setAttribute('id', rec.id);
        });
        updateObjectCount();
      });

      // ---------- Input handlers ----------
      const sceneEl = document.querySelector('a-scene');
      sceneEl.addEventListener('click', ()=>{ if(isResizing) return; if(mode==='tap') placeInFront(2); }, {passive:true});
      sceneEl.addEventListener('touchstart', ()=>{ if(isResizing) return; if(mode==='tap') placeInFront(2); }, {passive:true});

      // HTTPS hint
      if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        console.warn('Camera access requires HTTPS. Use https:// or localhost during dev.');
      }

      //test
      // Sample GLB catalog
const GLB = { 
  duck: { url:'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Assets/main/Models/Duck/glTF-Binary/Duck.glb', scale:'0.02 0.02 0.02' },
  //fox:  { url:'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Fox/glTF-Binary/Fox.glb',   scale:'0.03 0.03 0.03', animation:true },
  
  box:  { url:'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Assets/main/Models/Box/glTF-Binary/Box.glb',  scale:'0.5 0.5 0.5' },
        //box:  { url:'https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Box/glTF-Binary/Box.glb',  scale:'0.5 0.5 0.5' },
  avocado: { url:'https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Assets/main/Models/Avocado/glTF-Binary/Avocado.glb', scale:'0.05 0.05 0.05' },
  piano: {url: 'https://drive.google.com/file/d/1vdhjhPHiFXlA4LPk_rR87ScEynU_Bxy4/view?usp=sharing'},
  ghost: {url: 'https://drive.google.com/file/d/1gFdEKyyKw1BEt3z1mIUvm3bkBzxizMVd/view?usp=sharing'}
  
};

function placeGLBInFront(name='duck', withFrame=false, distanceM=2){
  const spec = GLB[name];
  if (!spec) { console.warn('Unknown GLB key:', name); return null; }

  const camEl = document.getElementById('cam');
  const camObj = camEl.object3D;

  // Camera's forward: local -Z transformed to world
  const forward = new THREE.Vector3(0, 0, -0.5).applyQuaternion(camObj.quaternion).normalize();

  const camPos = new THREE.Vector3();
  camObj.getWorldPosition(camPos);

  // Place in front of camera along forward
  const target = camPos.clone().add(forward.multiplyScalar(distanceM));
  target.y += 0.2;

  const coords = { x: target.x, y: target.y, z: target.z };
  console.log(`[GLB] Forward=`, forward, `Placing "${name}" at`, coords);

  // Wrapper so we can rotate/scale easily
  const wrapper = document.createElement('a-entity');
  wrapper.setAttribute('position', `${coords.x} ${coords.y} ${coords.z}`);

  const model = document.createElement('a-entity');
  model.setAttribute('gltf-model', spec.url);
  model.setAttribute('scale', spec.scale);
  model.setAttribute('crossorigin', 'anonymous');
  if (spec.animation) model.setAttribute('animation-mixer', '');
  wrapper.appendChild(model);

  if (withFrame){
    const frame = document.createElement('a-box');
    frame.setAttribute('scale', '0.5 0.5 0.5');
    frame.setAttribute('material', 'wireframe:true; transparent:true; opacity:0.6');
    wrapper.appendChild(frame);
  }

  document.querySelector('a-scene').appendChild(wrapper);

  // Confirm actual world position after attachment
  setTimeout(() => {
    const wp = new THREE.Vector3();
    wrapper.object3D.getWorldPosition(wp);
    console.log(`[GLB] "${name}" world position confirmed:`, { x: wp.x, y: wp.y, z: wp.z });
  }, 0);

  return { entity: wrapper, coords };
}


// Connect to the backend WebSocket server
import { io } from "socket.io-client";
const socket = io("ws://localhost:3000");

socket.on('connect', () => {
  console.log('Connected:', socket.id); });

// Listen for events
socket.on("welcome", (data) => {
  console.log("Received welcome:", data);
});

socket.on("position_status", (data) => {
  console.log("Position status:", data);
});

socket.on("off_boundaries", (data) => {
  console.log("Off boundaries:", data);
});

// Send user position to backend
function sendPosition(lat, lon) {
  socket.emit("user_position", { lat, lon });
}

// Example usage
sendPosition(40.7128, -74.0060);
      

    </script>
  </body>
</html>
