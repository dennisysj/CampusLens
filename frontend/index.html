<html>
  <head>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <style>
      .ui-panel{position:fixed;top:10px;left:10px;z-index:100;background:rgba(0,0,0,.7);padding:15px;border-radius:10px;color:#fff;font-family:Arial,sans-serif}
      .ui-button{background:#4CAF50;border:none;color:#fff;padding:10px 15px;margin:5px;border-radius:5px;cursor:pointer;font-size:14px}
      .ui-button:hover{background:#45a049}
      .ui-button.active{background:#2196F3}
      .ui-button.delete{background:#f44336}
      .ui-button.delete:hover{background:#da190b}
      .object-counter{margin-top:10px;font-size:12px}
      .instructions{position:fixed;bottom:10px;left:10px;z-index:100;background:rgba(0,0,0,.7);padding:6px;border-radius:5px;color:#fff;font-family:Arial,sans-serif;font-size:.1em}
    </style>
  </head>
  <body style="margin:0; overflow:hidden;">
    <!-- UI Panel -->
    <div class="ui-panel">
      <div>
        <button class="ui-button active" id="cube-btn" onclick="selectObjectType('cube')">Cube</button>
        <button class="ui-button" id="sphere-btn" onclick="selectObjectType('sphere')">Sphere</button>
        <button class="ui-button" id="cylinder-btn" onclick="selectObjectType('cylinder')">Cylinder</button>
      </div>
      <div>
        <button class="ui-button delete" onclick="deleteSelectedObject()">Delete Selected</button>
        <button class="ui-button delete" onclick="clearAllObjects()">Clear All</button>
      </div>
      <div class="object-counter">Objects: <span id="object-count">0</span></div>
    </div>

    <div class="instructions">Tap to Place</div>

    <!-- live camera feed -->
    <video id="cam" autoplay playsinline
      style="position:fixed; width:100%; height:100%; object-fit:cover; z-index:-1;"></video>

    <a-scene embedded>
      <!-- enables mouse-based raycasting onto entities -->
      <a-entity cursor="rayOrigin: mouse"
                raycaster="objects: a-box, a-sphere, a-cylinder, #ground"></a-entity>

      <!-- placement plane (tilted 45Â° in your code) -->
      <a-plane id="ground"
               rotation="-45 0 0"
               width="100" height="100"
               position="0 0 0"
               material="side: double; opacity: 0; transparent: true"
               visible="true"></a-plane>

      <a-entity camera position="0 2 2"></a-entity>
    </a-scene>

    <script>
      // Keep track of placed objects.
      const registry = new Map(); // id -> { el, type, position, placedAt, sessionId }

      const objectTypes = {
        cube: { primitive: 'a-box', color: 'orange', width: 0.5, height: 0.5, depth: 0.5 },
        sphere: { primitive: 'a-sphere', color: 'blue', radius: 0.3 },
        cylinder: { primitive: 'a-cylinder', color: 'green', radius: 0.3, height: 0.6 }
      };

      let currentObjectType = 'cube';
      let selectedObject = null;
      let objectCounter = 0;

      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => document.getElementById("cam").srcObject = stream);

      const sceneEl = document.querySelector('a-scene');

      sceneEl.addEventListener('loaded', () => {
        console.log('Scene loaded, setting up click handlers');

        const cameraEl = sceneEl.querySelector('[camera]');
        const threeCamera = cameraEl.getObject3D('camera');
        const ground = document.querySelector('#ground');
        const canvas = sceneEl.canvas;

        function selectObjectType(type) {
          currentObjectType = type;
          document.querySelectorAll('.ui-button').forEach(btn => btn.classList.remove('active'));
          document.getElementById(type + '-btn').classList.add('active');
        }

        function createObject(position) {
          console.log("------------CREATE OBJECT--------------------");
          const objData = objectTypes[currentObjectType];
          const newObj = document.createElement(objData.primitive);

          // Generate a UUID and use it as the element's id
          const id = crypto.randomUUID();
          newObj.setAttribute('id', id);
          newObj.dataset.counter = String(objectCounter++); // optional tracking

          // Base attributes
          newObj.setAttribute('position', `${position.x} ${position.y} ${position.z}`);
          newObj.setAttribute('visible', true);
          newObj.setAttribute('material', `color: ${objData.color}`);
          newObj.dataset.baseColor = objData.color;

          // Geometry
          if (currentObjectType === 'cube') {
            newObj.setAttribute('width', objData.width);
            newObj.setAttribute('height', objData.height);
            newObj.setAttribute('depth', objData.depth);
          } else if (currentObjectType === 'sphere') {
            newObj.setAttribute('radius', objData.radius);
          } else if (currentObjectType === 'cylinder') {
            newObj.setAttribute('radius', objData.radius);
            newObj.setAttribute('height', objData.height);
          }

          // Click to select
          newObj.addEventListener('click', selectObject);

          // Add to scene
          sceneEl.appendChild(newObj);
          updateObjectCount();

          // Registry record (use newObj here)
          const placedAt = new Date().toISOString();
          const sessionId = localStorage.getItem('sessionId') || (() => {
            const s = crypto.randomUUID();
            localStorage.setItem('sessionId', s);
            return s;
          })();

          const record = {
            id,
            type: currentObjectType,
            position: { x: position.x, y: position.y, z: position.z },
            placedAt,
            sessionId
          };
          registry.set(id, { el: newObj, ...record });

          // Logs
          console.log("------------COORDINATES--------------------");
          console.log(`ðŸ“ Placed ${record.type} ${id} at x=${position.x.toFixed(2)}, y=${position.y.toFixed(2)}, z=${position.z.toFixed(2)}`);
          console.log(`ðŸŽ¯ A-Frame element id: ${newObj.id} (counter ${newObj.dataset.counter})`);
          console.log("------------------------------------------------");

          // send to backend (will need CORS on server)
          fetch('http://localhost:3000/placements', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(record)
          }).catch(err => console.error('POST /placements failed:', err));

          return newObj;
        }

        function placeObject(event) {
          console.log('Place object called!');
          event.stopPropagation();

          const x = (event.touches?.[0]?.clientX ?? event.clientX);
          const y = (event.touches?.[0]?.clientY ?? event.clientY);
          const rect = canvas.getBoundingClientRect();
          const mouse = new THREE.Vector2(
            ((x - rect.left) / rect.width) * 2 - 1,
            -((y - rect.top) / rect.height) * 2 + 1
          );

          const raycaster = new THREE.Raycaster();
          raycaster.setFromCamera(mouse, threeCamera);

          const hits = raycaster.intersectObject(ground.object3D, true);
          console.log('Raycast hits:', hits.length);

          if (hits.length) {
            const p = hits[0].point;
            console.log('Hit point:', p);
            createObject(p);
          } else {
            console.log('No hit detected - click not on ground plane');
          }
        }

        function selectObject(event) {
          event.stopPropagation();
          if (selectedObject) {
            selectedObject.setAttribute('material', 'color: ' + getOriginalColor(selectedObject));
          }
          selectedObject = event.target;
          selectedObject.setAttribute('material', 'color: red');
          console.log('Selected object:', selectedObject.id);
        }

        function getOriginalColor(obj) {
          return obj.dataset.baseColor || 'gray';
        }

        function deleteSelectedObject() {
          if (selectedObject) {
            registry.delete(selectedObject.id);
            sceneEl.removeChild(selectedObject);
            selectedObject = null;
            updateObjectCount();
          }
        }

        function clearAllObjects() {
          const objects = sceneEl.querySelectorAll('a-box, a-sphere, a-cylinder');
          objects.forEach(obj => {
            registry.delete(obj.id);
            sceneEl.removeChild(obj);
          });
          selectedObject = null;
          updateObjectCount();
        }

        function updateObjectCount() {
          const count = sceneEl.querySelectorAll('a-box, a-sphere, a-cylinder').length;
          document.getElementById('object-count').textContent = count;
        }

        // Expose UI handlers
        window.selectObjectType = selectObjectType;
        window.deleteSelectedObject = deleteSelectedObject;
        window.clearAllObjects = clearAllObjects;

        // Attach listeners
        canvas.addEventListener('click', placeObject, { passive: true });
        canvas.addEventListener('touchstart', placeObject, { passive: true });
        console.log('Event handlers attached to canvas');
      });
    </script>
  </body>
</html>
