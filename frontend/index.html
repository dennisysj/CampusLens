<!doctype html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <!-- AR.js for A-Frame (includes new-location-based components) -->
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
    <style>
      /* Full-screen, correct aspect on all devices */
      html, body {
        margin: 0;
        padding: 0;
        width: 100dvw;
        height: 100dvh;
        overflow: hidden;
      }
      a-scene {
        position: fixed !important;
        inset: 0 !important;
        width: 100dvw !important;
        height: 100dvh !important;
        z-index: 1 !important;
      }
      /* Let AR.js video fill safely without distortion (use 'cover' to crop) */
      video[playsinline] {
        position: fixed;
        inset: 0;
        width: 100dvw;
        height: 100dvh;
        object-fit: contain; /* change to 'cover' if you prefer edge-to-edge with crop */
        z-index: -1;
      }

      /* UI */
      .ui-panel{position:fixed;top:10px;left:10px;z-index:100;background:rgba(0,0,0,.7);padding:8px;border-radius:8px;color:#fff;font-family:Arial,sans-serif;max-width:90vw}
      .ui-button{background:#4CAF50;border:none;color:#fff;padding:6px 10px;margin:3px;border-radius:4px;cursor:pointer;font-size:11px;white-space:nowrap}
      .ui-button:hover{background:#45a049}
      .ui-button.active{background:#2196F3}
      .ui-button.delete{background:#f44336}
      .ui-button.delete:hover{background:#da190b}
      .object-counter{margin-top:6px;font-size:10px}
      .instructions{position:fixed;bottom:10px;left:10px;z-index:100;background:rgba(0,0,0,.7);padding:6px 10px;border-radius:5px;color:#fff;font-family:Arial,sans-serif;font-size:11px;max-width:90vw}
      .row{margin-top:6px}
      input[type="number"]{width:90px;border-radius:4px;border:none;padding:4px;margin-right:4px;font-size:11px}
      
      /* Responsive */
      @media (max-width: 768px) {
        .ui-panel{padding:6px;top:5px;left:5px}
        .ui-button{padding:5px 8px;margin:2px;font-size:10px}
        .object-counter{font-size:9px}
        .instructions{font-size:10px;bottom:5px;left:5px;padding:5px 8px}
        input[type="number"]{width:70px;padding:3px;font-size:10px}
      }
      @media (max-width: 400px) {
        .ui-panel{padding:4px;top:3px;left:3px}
        .ui-button{padding:4px 6px;margin:2px;font-size:9px}
        .object-counter{font-size:8px}
        .instructions{font-size:9px;bottom:3px;left:3px;padding:4px 6px}
        input[type="number"]{width:60px;padding:2px;font-size:9px}
      }

      /* iOS motion permission button */
      .ios-motion-btn{
        position:fixed;bottom:12px;left:12px;z-index:999;background:#2196F3;border:none;color:#fff;
        padding:8px 12px;border-radius:5px;cursor:pointer;font-size:12px;
      }
      @media (max-width: 768px) {.ios-motion-btn{bottom:8px;left:8px;padding:6px 10px;font-size:11px}}
      @media (max-width: 400px) {.ios-motion-btn{bottom:5px;left:5px;padding:5px 8px;font-size:10px}}
    </style>
  </head>
  <body>
    <!-- UI -->
    <div class="ui-panel">
      <div>
        <button class="ui-button active" id="cube-btn" onclick="selectObjectType('cube')">Cube</button>
        <button class="ui-button" id="sphere-btn" onclick="selectObjectType('sphere')">Sphere</button>
        <button class="ui-button" id="cylinder-btn" onclick="selectObjectType('cylinder')">Cylinder</button>
        <button class="ui-button" id="arrow-btn" onclick="selectObjectType('arrow')">Arrow</button>
        <button class="ui-button" id="textBox-btn" onclick="selectObjectType('textBox')">Text Box</button>
      </div>
      <div class="row">
        <button class="ui-button" onclick="mode='tap'; setActiveMode()">Tap-to-place (2 m)</button>
        <button class="ui-button" onclick="mode='gps'; setActiveMode()">GPS pin</button>
      </div>
      <div class="row" id="gps-row" style="display:none">
        <input id="lat" type="number" step="0.000001" placeholder="lat e.g. 49.2827">
        <input id="lon" type="number" step="0.000001" placeholder="lon e.g. -123.1207">
        <button class="ui-button" onclick="addAtInputs()">Add @ lat/lon</button>
      </div>
      <div class="row">
        <button class="ui-button delete" onclick="deleteSelectedObject()">Delete Selected</button>
        <button class="ui-button delete" onclick="clearAllObjects()">Clear All</button>
      </div>
      <div class="object-counter">Objects: <span id="object-count">0</span></div>
    </div>

    <div class="instructions">Camera will request permission. Tap to place (Tap mode) or add GPS pin.</div>

    <!-- A-Frame + AR.js -->
    <a-scene
      embedded
      vr-mode-ui="enabled:false"
      renderer="logarithmicDepthBuffer:true; alpha: true;"
      <!-- Let AR.js pick stream/display sizes to match device -->
      arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false">

      <!-- Basic camera (no GPS here; GPS anchor is created per-entity) -->
      <a-camera id="cam" position="0 0 0" look-controls="enabled: false" wasd-controls="enabled: false"></a-camera>

      <!-- Optional helper plane for editing (not real plane detection) -->
      <a-plane id="edit-plane" rotation="-90 0 0" width="200" height="200"
               position="0 0 -4" visible="false"></a-plane>

      <!-- Mouse cursor for desktop debugging -->
      <a-entity cursor="rayOrigin: mouse"
                raycaster="objects: a-box, a-sphere, a-cylinder, a-entity[id^='object-']"></a-entity>
    </a-scene>

    <!-- iOS motion permission -->
    <button id="iosPerm" class="ios-motion-btn">Enable Motion</button>

    <script>
      // ---------- UI state ----------
      let mode = 'tap'; // 'tap' or 'gps'
      function setActiveMode(){
        document.getElementById('gps-row').style.display = (mode==='gps')?'block':'none';
      }

      iosPerm.onclick = async () => {
        const DM = window.DeviceMotionEvent;
        if (DM && typeof DM.requestPermission === 'function') {
          try { await DM.requestPermission(); } catch(e) {}
        }
        iosPerm.remove();
      };

      // ---------- Object definitions ----------
      const objectTypes = {
        cube:{primitive:'a-box',color:'orange',width:0.5,height:0.5,depth:0.5},
        sphere:{primitive:'a-sphere',color:'blue',radius:0.3},
        cylinder:{primitive:'a-cylinder',color:'green',radius:0.3,height:0.6},
        arrow:{type:"group",parts:[
          {primitive:"a-cylinder",color:"#F00",height:0.6,radius:0.05,position:"0 0 0"},
          {primitive:"a-cone",color:"#F00",height:0.3,radiusBottom:0.12,position:"0 0.45 0"}]},
        textBox:{type:"group",parts:[
          {primitive:"a-plane",color:"#FFFFFF",width:1.5,height:0.6,position:"0 0 0"},
          {primitive:"a-entity",text:"value: Example Text; color: black; width: 2; align: center",position:"0 0.25 0"},
          {primitive:"a-sphere",radius:0.05,color:"red",position:"0.75 0.3 0.02",class:"resize-handle"},
          {primitive:"a-sphere",radius:0.05,color:"red",position:"-0.75 0.3 0.02",class:"resize-handle"},
          {primitive:"a-sphere",radius:0.05,color:"red",position:"0.75 -0.3 0.02",class:"resize-handle"},
          {primitive:"a-sphere",radius:0.05,color:"red",position:"-0.75 -0.3 0.02",class:"resize-handle"}]}
      };
      let currentObjectType='cube', selectedObject=null, objectCounter=0, isResizing=false;

      window.selectObjectType = (t)=>{
        currentObjectType=t;
        document.querySelectorAll('.ui-button').forEach(b=>b.classList.remove('active'));
        const btn=document.getElementById(t+'-btn'); if(btn) btn.classList.add('active');
      };

      // ---------- Build object ----------
      function buildObject(positionVec3){
        const sceneEl = document.querySelector('a-scene');
        const objData = objectTypes[currentObjectType];
        let newObj;

        if (objData.type==="group"){
          newObj = document.createElement("a-entity");
          newObj.setAttribute("position", `${positionVec3.x} ${positionVec3.y} ${positionVec3.z}`);
          objData.parts.forEach(part=>{
            const el=document.createElement(part.primitive);
            for(const [k,v] of Object.entries(part)){
              if(k==="primitive"||k==="position") continue;
              if(k==="text"){
                const m={}; v.split(";").forEach(s=>{
                  if(!s.trim()) return; const [kk,vv]=s.split(":").map(x=>x.trim()); m[kk]=isNaN(vv)?vv:parseFloat(vv);
                });
                el.setAttribute("text", m);
              }else el.setAttribute(k, v);
            }
            if(part.position) el.setAttribute("position", part.position);
            newObj.appendChild(el);
          });
          if(currentObjectType==="textBox") makeTextBoxResizable(newObj);
        }else{
          newObj = document.createElement(objData.primitive);
          newObj.setAttribute("position", `${positionVec3.x} ${positionVec3.y} ${positionVec3.z}`);
          newObj.setAttribute("visible", true);
          newObj.setAttribute("material", `color:${objData.color}`);
          newObj.dataset.baseColor = objData.color;
          if(currentObjectType==="cube"){ newObj.setAttribute("width",objData.width); newObj.setAttribute("height",objData.height); newObj.setAttribute("depth",objData.depth); }
          if(currentObjectType==="sphere") newObj.setAttribute("radius",objData.radius);
          if(currentObjectType==="cylinder"){ newObj.setAttribute("radius",objData.radius); newObj.setAttribute("height",objData.height); }
        }

        newObj.setAttribute("id", `object-${objectCounter++}`);
        newObj.addEventListener("click", selectObject);
        sceneEl.appendChild(newObj);
        updateObjectCount();
        return newObj;
      }

      function makeTextBoxResizable(ent){
        const plane = ent.querySelector("a-plane");
        const text  = ent.querySelector("a-entity[text]");
        const handles = Array.from(ent.querySelectorAll(".resize-handle"));
        ent.userData = { plane, text, handles };
      }

      // ---------- Placement ----------
      function placeInFront(distanceM=2){
        const camEl = document.getElementById('cam');
        const camObj = camEl.object3D;
        const dir = new THREE.Vector3();
        camObj.getWorldDirection(dir);
        const pos = new THREE.Vector3();
        camObj.getWorldPosition(pos);
        const target = pos.add(dir.multiplyScalar(distanceM));
        target.y += 0.2;
        buildObject(target);
      }

      function addAtLatLng(lat, lon){
        const sceneEl = document.querySelector('a-scene');
        const anchor = document.createElement('a-entity');
        anchor.setAttribute('gps-new-entity-place', `latitude:${lat}; longitude:${lon}`);
        anchor.setAttribute('id', `object-${objectCounter++}`);

        const child = buildObject(new THREE.Vector3(0,0,0));
        anchor.appendChild(child);
        sceneEl.appendChild(anchor);
        updateObjectCount();
        return anchor;
      }

      window.addAtInputs = ()=>{
        const lat=parseFloat(document.getElementById('lat').value);
        const lon=parseFloat(document.getElementById('lon').value);
        if(Number.isFinite(lat)&&Number.isFinite(lon)) addAtLatLng(lat,lon);
      };

      // ---------- Selection / deletion ----------
      function selectObject(e){
        e.stopPropagation();
        if(selectedObject) selectedObject.setAttribute('material', 'color:'+getOriginalColor(selectedObject));
        selectedObject = e.currentTarget;
        selectedObject.setAttribute('material','color:red');
      }
      function getOriginalColor(obj){ return obj.dataset?.baseColor || 'gray'; }

      window.deleteSelectedObject = ()=>{
        if(!selectedObject) return;
        const sceneEl = document.querySelector('a-scene');
        if (selectedObject.parentElement && selectedObject.parentElement.hasAttribute('gps-new-entity-place')){
          sceneEl.removeChild(selectedObject.parentElement);
        } else {
          sceneEl.removeChild(selectedObject);
        }
        selectedObject=null; updateObjectCount();
      };

      window.clearAllObjects = ()=>{
        const sceneEl = document.querySelector('a-scene');
        sceneEl.querySelectorAll("a-box, a-sphere, a-cylinder, a-entity[id^='object-']").forEach(n=>{
          if(n.parentElement===sceneEl) sceneEl.removeChild(n);
          else if(n.parentElement?.hasAttribute('gps-new-entity-place')) sceneEl.removeChild(n.parentElement);
        });
        selectedObject=null; updateObjectCount();
      };

      function updateObjectCount(){
        const sceneEl = document.querySelector('a-scene');
        const count = sceneEl.querySelectorAll("a-entity[id^='object-']").length;
        document.getElementById('object-count').textContent = count;
      }

      // ---------- Input handlers ----------
      const sceneEl = document.querySelector('a-scene');
      sceneEl.addEventListener('click', ()=>{ if(isResizing) return; if(mode==='tap') placeInFront(2); }, {passive:true});
      sceneEl.addEventListener('touchstart', ()=>{ if(isResizing) return; if(mode==='tap') placeInFront(2); }, {passive:true});

      // HTTPS hint
      if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        console.warn('Camera access requires HTTPS. Use https:// or localhost during dev.');
      }
    </script>
  </body>
</html>
