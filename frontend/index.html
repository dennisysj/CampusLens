<!doctype html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <!-- AR.js for A-Frame (includes new-location-based components) -->
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
    <style>
      .ui-panel{position:fixed;top:10px;left:10px;z-index:100;background:rgba(0,0,0,.7);padding:15px;border-radius:10px;color:#fff;font-family:Arial,sans-serif}
      .ui-button{background:#4CAF50;border:none;color:#fff;padding:10px 15px;margin:5px;border-radius:5px;cursor:pointer;font-size:14px}
      .ui-button:hover{background:#45a049}
      .ui-button.active{background:#2196F3}
      .ui-button.delete{background:#f44336}
      .ui-button.delete:hover{background:#da190b}
      .object-counter{margin-top:10px;font-size:12px}
      .instructions{position:fixed;bottom:10px;left:10px;z-index:100;background:rgba(0,0,0,.7);padding:6px;border-radius:5px;color:#fff;font-family:Arial,sans-serif;font-size:.9em}
      .row{margin-top:8px}
      input[type="number"]{width:130px;border-radius:4px;border:none;padding:6px;margin-right:6px}
    </style>
  </head>
  <body style="margin:0; overflow:hidden;">
    <!-- UI -->
    <div class="ui-panel">
      <div>
        <button class="ui-button active" id="cube-btn" onclick="selectObjectType('cube')">Cube</button>
        <button class="ui-button" id="sphere-btn" onclick="selectObjectType('sphere')">Sphere</button>
        <button class="ui-button" id="cylinder-btn" onclick="selectObjectType('cylinder')">Cylinder</button>
        <button class="ui-button" id="arrow-btn" onclick="selectObjectType('arrow')">Arrow</button>
        <button class="ui-button" id="textBox-btn" onclick="selectObjectType('textBox')">Text Box</button>
      </div>
      <div class="row">
        <button class="ui-button" onclick="mode='tap'; setActiveMode()">Tap-to-place (2 m)</button>
        <button class="ui-button" onclick="mode='gps'; setActiveMode()">GPS pin</button>
      </div>
      <div class="row" id="gps-row" style="display:none">
        <input id="lat" type="number" step="0.000001" placeholder="lat e.g. 49.2827">
        <input id="lon" type="number" step="0.000001" placeholder="lon e.g. -123.1207">
        <button class="ui-button" onclick="addAtInputs()">Add @ lat/lon</button>
      </div>
      <div class="row">
        <button class="ui-button delete" onclick="deleteSelectedObject()">Delete Selected</button>
        <button class="ui-button delete" onclick="clearAllObjects()">Clear All</button>
      </div>
      <div class="object-counter">Objects: <span id="object-count">0</span></div>
    </div>

    <div class="instructions">Loading camera... Please allow camera access when prompted.</div>
    
    <!-- Camera permission button -->
    <button id="cameraPerm" style="position:fixed;bottom:50px;right:12px;z-index:999;background:#4CAF50;border:none;color:#fff;padding:10px 15px;border-radius:5px;cursor:pointer;">Enable Camera</button>

    <!-- A-Frame + AR.js -->
    <a-scene
      embedded
      vr-mode-ui="enabled:false"
      renderer="logarithmicDepthBuffer:true"
      arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: true; detectionMode: mono_and_matrix; matrixCodeType: 3x3;">

      <!-- Location-enabled camera (new API) -->
      <a-camera id="cam"
        gps-new-camera="gpsMinDistance: 5; positionMinAccuracy: 100"
        arjs-device-orientation-controls="smoothingFactor:0.1"
        wasd-controls="enabled: false">
      </a-camera>

      <!-- (Optional) invisible “edit plane” so your existing raycaster can hit something.
           This is NOT real plane detection; it’s just a helper for selection/resizing. -->
      <a-plane id="edit-plane" rotation="-90 0 0" width="200" height="200"
               position="0 0 -4" visible="false"></a-plane>

      <!-- Mouse cursor for desktop debugging -->
      <a-entity cursor="rayOrigin: mouse"
                raycaster="objects: a-box, a-sphere, a-cylinder, a-entity[id^='object-']"></a-entity>

      <!-- Test AR marker for debugging -->
      <a-marker-camera preset="hiro">
        <a-box position="0 0.5 0" material="color: yellow;"></a-box>
      </a-marker-camera>
    </a-scene>

    <!-- iOS motion permission -->
    <button id="iosPerm" style="position:fixed;bottom:12px;left:12px;z-index:999;">Enable Motion</button>

    <script>
      // ---------- UI state ----------
      let mode = 'tap'; // 'tap' (place 2m ahead) or 'gps' (create gps-new-entity-place)
      function setActiveMode(){
        document.getElementById('gps-row').style.display = (mode==='gps')?'block':'none';
      }

      iosPerm.onclick = async () => {
        const DM = window.DeviceMotionEvent;
        if (DM && typeof DM.requestPermission === 'function') {
          try { await DM.requestPermission(); } catch(e) {}
        }
        iosPerm.remove();
      };

      // ---------- Your object definitions ----------
      const objectTypes = {
        cube:{primitive:'a-box',color:'orange',width:0.5,height:0.5,depth:0.5},
        sphere:{primitive:'a-sphere',color:'blue',radius:0.3},
        cylinder:{primitive:'a-cylinder',color:'green',radius:0.3,height:0.6},
        arrow:{type:"group",parts:[
          {primitive:"a-cylinder",color:"#F00",height:0.6,radius:0.05,position:"0 0 0"},
          {primitive:"a-cone",color:"#F00",height:0.3,radiusBottom:0.12,position:"0 0.45 0"}]},
        textBox:{type:"group",parts:[
          {primitive:"a-plane",color:"#FFFFFF",width:1.5,height:0.6,position:"0 0 0"},
          {primitive:"a-entity",text:"value: Example Text; color: black; width: 2; align: center",position:"0 0.25 0"},
          {primitive:"a-sphere",radius:0.05,color:"red",position:"0.75 0.3 0.02",class:"resize-handle"},
          {primitive:"a-sphere",radius:0.05,color:"red",position:"-0.75 0.3 0.02",class:"resize-handle"},
          {primitive:"a-sphere",radius:0.05,color:"red",position:"0.75 -0.3 0.02",class:"resize-handle"},
          {primitive:"a-sphere",radius:0.05,color:"red",position:"-0.75 -0.3 0.02",class:"resize-handle"}]}
      };
      let currentObjectType='cube', selectedObject=null, objectCounter=0, isResizing=false;

      // Expose selection functions to buttons
      window.selectObjectType = (t)=>{
        currentObjectType=t;
        document.querySelectorAll('.ui-button').forEach(b=>b.classList.remove('active'));
        const btn=document.getElementById(t+'-btn'); if(btn) btn.classList.add('active');
      };

      // ---------- Create object (common) ----------
      function buildObject(positionVec3){
        const sceneEl = document.querySelector('a-scene');
        const objData = objectTypes[currentObjectType];
        let newObj;

        if (objData.type==="group"){
          newObj = document.createElement("a-entity");
          newObj.setAttribute("position", `${positionVec3.x} ${positionVec3.y} ${positionVec3.z}`);
          objData.parts.forEach(part=>{
            const el=document.createElement(part.primitive);
            for(const [k,v] of Object.entries(part)){
              if(k==="primitive"||k==="position") continue;
              if(k==="text"){
                const m={}; v.split(";").forEach(s=>{
                  if(!s.trim()) return; const [kk,vv]=s.split(":").map(x=>x.trim()); m[kk]=isNaN(vv)?vv:parseFloat(vv);
                });
                el.setAttribute("text", m);
              }else el.setAttribute(k, v);
            }
            if(part.position) el.setAttribute("position", part.position);
            newObj.appendChild(el);
          });
          if(currentObjectType==="textBox") makeTextBoxResizable(newObj);
        }else{
          newObj = document.createElement(objData.primitive);
          newObj.setAttribute("position", `${positionVec3.x} ${positionVec3.y} ${positionVec3.z}`);
          newObj.setAttribute("visible", true);
          newObj.setAttribute("material", `color:${objData.color}`);
          newObj.dataset.baseColor = objData.color;
          if(currentObjectType==="cube"){ newObj.setAttribute("width",objData.width); newObj.setAttribute("height",objData.height); newObj.setAttribute("depth",objData.depth); }
          if(currentObjectType==="sphere") newObj.setAttribute("radius",objData.radius);
          if(currentObjectType==="cylinder"){ newObj.setAttribute("radius",objData.radius); newObj.setAttribute("height",objData.height); }
        }

        newObj.setAttribute("id", `object-${objectCounter++}`);
        newObj.addEventListener("click", selectObject);
        sceneEl.appendChild(newObj);
        updateObjectCount();
        return newObj;
      }

      function makeTextBoxResizable(ent){
        const plane = ent.querySelector("a-plane");
        const text  = ent.querySelector("a-entity[text]");
        const handles = Array.from(ent.querySelectorAll(".resize-handle"));
        ent.userData = { plane, text, handles };
      }

      // ---------- Placement modes ----------
      // B) Tap-to-place ~2m in front of camera (simple, no plane detection)
      function placeInFront(distanceM=2){
        const camEl = document.getElementById('cam');
        const camObj = camEl.object3D;
        const dir = new THREE.Vector3();
        camObj.getWorldDirection(dir); // unit vector pointing forward
        const pos = new THREE.Vector3();
        camObj.getWorldPosition(pos);
        const target = pos.add(dir.multiplyScalar(distanceM));
        // lift slightly so it’s visible
        target.y += 0.2;
        buildObject(target);
      }

      // A) GPS: create a gps-new-entity-place wrapper, then put your object inside at local (0 0 0)
      function addAtLatLng(lat, lon){
        const sceneEl = document.querySelector('a-scene');
        const anchor = document.createElement('a-entity');
        anchor.setAttribute('gps-new-entity-place', `latitude:${lat}; longitude:${lon}`);
        anchor.setAttribute('id', `object-${objectCounter++}`);

        // put your geometry as child at local 0,0,0:
        const child = buildObject(new THREE.Vector3(0,0,0));
        anchor.appendChild(child);
        sceneEl.appendChild(anchor);
        updateObjectCount();
        return anchor;
      }

      window.addAtInputs = ()=>{
        const lat=parseFloat(document.getElementById('lat').value);
        const lon=parseFloat(document.getElementById('lon').value);
        if(Number.isFinite(lat)&&Number.isFinite(lon)) addAtLatLng(lat,lon);
      };

      // ---------- Selection / deletion ----------
      function selectObject(e){
        e.stopPropagation();
        if(selectedObject) selectedObject.setAttribute('material', 'color:'+getOriginalColor(selectedObject));
        selectedObject = e.currentTarget;
        selectedObject.setAttribute('material','color:red');
      }
      function getOriginalColor(obj){ return obj.dataset?.baseColor || 'gray'; }

      window.deleteSelectedObject = ()=>{
        if(!selectedObject) return;
        const sceneEl = document.querySelector('a-scene');
        if (selectedObject.parentElement && selectedObject.parentElement.hasAttribute('gps-new-entity-place')){
          // if you clicked the child, remove the parent anchor so GPS object fully goes away
          sceneEl.removeChild(selectedObject.parentElement);
        } else {
          sceneEl.removeChild(selectedObject);
        }
        selectedObject=null; updateObjectCount();
      };

      window.clearAllObjects = ()=>{
        const sceneEl = document.querySelector('a-scene');
        sceneEl.querySelectorAll("a-box, a-sphere, a-cylinder, a-entity[id^='object-']").forEach(n=>{
          if(n.parentElement===sceneEl) sceneEl.removeChild(n);
          else if(n.parentElement?.hasAttribute('gps-new-entity-place')) sceneEl.removeChild(n.parentElement);
        });
        selectedObject=null; updateObjectCount();
      };

      function updateObjectCount(){
        const sceneEl = document.querySelector('a-scene');
        const count = sceneEl.querySelectorAll("a-entity[id^='object-']").length;
        document.getElementById('object-count').textContent = count;
      }

      // ---------- Input handlers ----------
      // In Tap mode, tapping anywhere drops 2m ahead.
      const sceneEl = document.querySelector('a-scene');
      sceneEl.addEventListener('click', (e)=>{ if(isResizing) return; if(mode==='tap') placeInFront(2); }, {passive:true});
      sceneEl.addEventListener('touchstart', (e)=>{ if(isResizing) return; if(mode==='tap') placeInFront(2); }, {passive:true});

      // ---------- Demo: seed a GPS pin (edit these to test outdoors) ----------
      // addAtLatLng(49.2827, -123.1207); // ← uncomment to spawn one at these coords

      // ---------- Camera initialization and error handling ----------
      document.addEventListener('DOMContentLoaded', function() {
        const scene = document.querySelector('a-scene');
        const cameraPermBtn = document.getElementById('cameraPerm');
        
        // Check if we're on HTTPS (required for camera access)
        if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
          alert('Camera access requires HTTPS. Please use https:// or localhost');
        }

        // Handle AR.js initialization
        scene.addEventListener('arjs-video-loaded', function() {
          console.log('AR.js video loaded successfully');
          document.querySelector('.instructions').textContent = 'Camera ready! Tap to place objects.';
          cameraPermBtn.style.display = 'none';
        });

        scene.addEventListener('arjs-video-error', function() {
          console.error('AR.js video error');
          document.querySelector('.instructions').textContent = 'Camera error. Click "Enable Camera" button.';
          cameraPermBtn.style.display = 'block';
        });

        // Camera permission button handler
        cameraPermBtn.onclick = function() {
          if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true })
              .then(function(stream) {
                console.log('Camera permission granted');
                document.querySelector('.instructions').textContent = 'Camera permission granted. Reloading...';
                setTimeout(() => location.reload(), 1000);
              })
              .catch(function(error) {
                console.error('Camera permission denied:', error);
                document.querySelector('.instructions').textContent = 'Camera permission denied. Please allow camera access.';
              });
          } else {
            document.querySelector('.instructions').textContent = 'Camera not supported on this device.';
          }
        };

        // Auto-request camera permissions
        setTimeout(() => {
          if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true })
              .then(function(stream) {
                console.log('Camera permission granted automatically');
                cameraPermBtn.style.display = 'none';
              })
              .catch(function(error) {
                console.log('Camera permission not granted automatically, showing button');
                cameraPermBtn.style.display = 'block';
              });
          }
        }, 1000);
      });
    </script>
  </body>
</html>
